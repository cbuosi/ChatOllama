@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<br />

<div class="card">

    <div class="card-header">
        <img src="~/Assets/Imagens/BBS.png" alt="BBS Informática" /> <i style="display:none" id="sp1" class="fa-solid fa-spinner fa-spin-pulse"></i>
    </div>

    <div class="card-body">

        <div class="row">
            <div class="col-4">
                <label for="nmModelo">Modelo</label>
                <select id="idModelo" class="form-select" aria-label="Default select example">
                    <option value="qwen:32b">qwen:32b (18 GB)</option>
                    <option selected value="qwen3:8b">qwen3:8b (5.2 GB)</option>
                    <option value="qwen3:14b">qwen3:14b (9.3 GB)</option>
                    <option value="qwen3:30b">qwen3:30b (18 GB)</option>
                    <option value="deepseek-r1:14b">deepseek-r1:14b (9.0 GB)</option>
                    <option value="gpt-oss:20b">gpt-oss:20b (13 GB)</option>
                </select>
                <small class="form-text text-muted">Ao/se mudar o modelo, o historico será perdido.</small>
            </div>

            <div class="col-8">
                <label>Prompt</label>
                <input id="idPrompt" type="text" class="form-control" placeholder="Digite seu prompt">
                <small class="form-text text-muted">A resposta pode demorar alguns segundos.</small>
            </div>

        </div>

        <div class="row">
            <div class="col-12">
                <label>Resposta</label><i style="display:none" id="sp2" class="fa-solid fa-spinner fa-spin-pulse"></i>
                <textarea id="idSaida" class="form-control" rows="10"></textarea>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-4">
                <button id="btnEnviar" type="button" class="btn btn-success" onclick="return EnviaPrompt();"><i class="fa-solid fa-share"></i>&nbsp;Enviar&nbsp;<i style="display:none" id="sp3" class="fa-solid fa-spinner fa-spin-pulse"></i></button>
                &nbsp;
                <button id="btnLimpar" type="button" class="btn btn-warning" onclick="return Limpar();"> <i class="fa-solid fa-delete-left"></i>&nbsp;Limpar&nbsp;</button>
            </div>
            <div class="col-4">
                <label id="lbl1">Prompt</label>
            </div>
        </div>

    </div>

    <div class="card-footer">
        <img src="~/Assets/Imagens/BBS.png" alt="BBS Informática" />
        <img src="~/Assets/Imagens/toto2.gif" alt="BBS Informática" />
    </div>

</div>

@section Scripts {

    <script>

        const URL_OLLAMA = "http://192.168.18.21:11434/api/generate";
        const T_FADE = 500;
        var arrContext = [];
        var eval_count = 0;


        $(document).ready(function ()
        {
            try
            {

                console.log("Página carregada!");


                $('#idPrompt').keypress(function(event) {
                  // Check if the pressed key is Enter (key code 13)
                  if (event.which === 13)
                  {
                    event.preventDefault();
                    EnviaPrompt();
                  }
                });

                $('#idSaida').prop('readonly', true);
                AtuStatus();

            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
            }

        });


        function EnviaPrompt()
        {
            try
            {

                var strPromt = $("#idPrompt").val();

                if (strPromt.trim() == '')
                {
                    console.log('Prompt vazio!');
                    IncluirResp('Atenção', 'Prompt vazio!');
                    return false;
                }

                var jsonString = '';
                var strModelo = $('#idModelo').val();
                IncluirResp('Prompt', strPromt);

                //const dataToSend = {model: "qwen3:8b",
                //                    prompt: strPromt,
                //                    context: arrContext,
                //                    think: false,
                //                    stream: false};

                const dataToSend = {model: strModelo,
                                    prompt: strPromt,
                                    context: arrContext,
                                    think: false,
                                    stream: false,
                                    options: {think: false}};


                console.log("Prompt: " + strPromt);


                jsonString = JSON.stringify(dataToSend);

                // -
                // jsonString = '{"model": "qwen3:8b","prompt": "how much is 4 * 3 and why", "think": false, "stream": false}';
                // -

                $.ajax({
                    url: URL_OLLAMA,
                    type: "POST", 
                    contentType: "application/json",
                    data: jsonString,
                    beforeSend: function( jqXHR, settings )
                    {
                        $("#idPrompt").val('');
                        LigarItens(true);
                    },
                    success: function(data, textStatus, jqXHR)
                    {
                        //
                        console.log("success:", textStatus);
                        console.log({data});
                        // $("#idSaida").val(function(i, currentVal) {return currentVal + ObterTempoEstampa() + ' - ' + data.response + '\n';});
                        arrContext = data.context;
                        eval_count += data.eval_count;
                        //
                        IncluirResp('Resultado', data.response);
                        AtuStatus();
                        //
                    },
                    error: function(jqXHR, textStatus, errorThrown)
                    {
                        console.log("error:", textStatus);
                    },
                    complete: function( jqXHR, textStatus )
                    {
                        console.log("complete:", textStatus);
                        LigarItens(false);
                    }
                });

                return false;

            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
                return false;
            }
        }


        //{  "model": "qwen3:8b","prompt": "how much is 4 * 3 and why", "think": false, "stream": false}
        function ObterTempoEstampa()
        {
            try
            {
                var ret = "";

                // Create a new Date object representing the current date and time
                const now = new Date();

                // Get the current hour (0-23)
                const hour = now.getHours();

                // Get the current minute (0-59)
                const minute = now.getMinutes();

                // Get the current second (0-59)
                const second = now.getSeconds();

                // Get the current millisecond (0-999)
                const millisecond = now.getMilliseconds();

                ret = `${hour}:${minute}:${second}.${millisecond}`;

                return ret;
            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
                return '';
            }
        }

        function AtuStatus()
        {
            try
            {
                $('#lbl1').text(`Context: ${arrContext.length} Eval: ${eval_count}`)
            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
            }
        }

        function IncluirResp(a, b)
        {
            try
            {
                //
                $("#idSaida").val(function(i, currentVal) {return currentVal + a + ' - ' + ObterTempoEstampa() + ' - ' + b + '\n';});
                //
                return true;
            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
                return true;
            }
        }

        function Limpar()
        {
            try
            {
                arrContext = [];
                eval_count = 0;
                $("#idPrompt").val('');
                $("#idSaida").val('');
                AtuStatus();
            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
            }
        }


        function LigarItens(OnOff)
        {

            try
            {

                $('#idPrompt').prop('disabled', OnOff);
                //$('#idSaida').prop('disabled', OnOff);
                $('#idModelo').prop('disabled', OnOff);
                $('#btnEnviar').prop('disabled', OnOff);
                $('#btnLimpar').prop('disabled', OnOff);

                if (OnOff == true)
                {
                    $('#sp1').fadeIn(T_FADE);
                    $('#sp2').fadeIn(T_FADE);
                    $('#sp3').fadeIn(T_FADE);
                    $('#idPrompt').focus().select();
                }
                else
                {
                    $('#sp1').fadeOut(T_FADE);
                    $('#sp2').fadeOut(T_FADE);
                    $('#sp3').fadeOut(T_FADE);
                }

            }
            catch (erro)
            {
                console.error("Ocorreu um erro:", erro.message);
            }


        }

    </script>
}

